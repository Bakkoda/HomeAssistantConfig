######################################################################
#       Server Monitoring
######################################################################
  # Notify on HDD temps over 105F
  - alias: 'Monitor hard drive temps'
    trigger:
        platform: numeric_state
        entity_id:
          - sensor.kennel_wdc_wd1003fbyz_010fb0_temperatures_temperature
          - sensor.kennel_wdc_wd120emfz_11a6ja0_temperatures_temperature
          - sensor.kennel_wdc_wd120emfz_11a6ja0_temperatures_temperature_2
          - sensor.kennel_wdc_wd120emfz_11a6ja0_temperatures_temperature_3
          - sensor.kennel_st3000vn000_1hj166_temperatures_temperature
          - sensor.kennel_st3000vn000_1hj166_temperatures_temperature_2
        above: 105
    action:
        service: notify.homeassistant
        data_template:
            message: "***HA*** - {{ trigger.to_state.attributes.friendly_name }} is currently above 105° F with a temp of {{ trigger.to_state.state }}° F @here - {{now().strftime('%B %d, %Y at %I:%M%p')}}"
            target: 613741597594615828

  # Notify when UPS state changes AKA power interruption
  - alias: 'Monitor UPS condition'
    trigger:
        platform: state
        entity_id: sensor.ups_status
    action:
        service: notify.homeassistant
        data_template:
            message: "***HA*** - Battery Backup {{ trigger.to_state.attributes.friendly_name }} is currently in an abnormal state ({{ trigger.to_state.state }}) @everyone - {{now().strftime('%B %d, %Y at %I:%M%p')}}"
            target: 613741597594615828

  # Send WOL to Kennel when UPS comes back online
  - alias: 'Kennel UPS Restart'
    trigger:
        platform: state
        entity_id: sensor.ups_status
        from: "ONBATT"
        to: "ONLINE"
    action:
      - service: switch.turn_on
        entity_id: switch.kennel

  # Notify when Ansible has done a VM update
  - alias: 'Ansible updates'
    trigger:
        platform: state
        entity_id: sensor.ansible_status, sensor.pihole_status
    action:
        service: notify.homeassistant
        data_template:
            message: "***HA*** - {{ trigger.to_state.attributes.friendly_name }} has been updated - {{now().strftime('%B %d, %Y at %I:%M%p')}}"
            target: 613741597594615828

  # Notify when Arq updates complete
  - alias: 'Arq updates'
    trigger:
        platform: state
        entity_id: sensor.servers_backups, sensor.personal_backups, sensor.servers_backups_ext, sensor.personal_backups_ext
    action:
        service: notify.homeassistant
        data_template:
            message: "***Arq*** - **{{ trigger.to_state.attributes.friendly_name }} backups completed** - {{now().strftime('%B %d, %Y at %I:%M%p')}}"
            target: 613741597594615828

  # Notify when Veeam updates complete
  - alias: 'Veeam updates'
    trigger:
        platform: state
        entity_id: sensor.critical_backups, sensor.weekly_backups
    action:
        service: notify.homeassistant
        data_template:
            message: "***Veeam*** - **{{ trigger.to_state.attributes.friendly_name }} VM backups completed** - {{now().strftime('%B %d, %Y at %I:%M%p')}}"
            target: 613741597594615828

  # Notify when Syncovery completes external backups
  - alias: 'Syncovery updates'
    trigger:
        platform: state
        entity_id: sensor.personal_data_ext, sensor.personal_pictures_ext, sensor.personal_users_ext, sensor.servers_data_ext, sensor.servers_speed_ext
    action:
        service: notify.homeassistant
        data_template:
            message: "***Syncovery*** - {{ trigger.to_state.attributes.friendly_name }} backups completed - {{now().strftime('%B %d, %Y at %I:%M%p')}}"
            target: 613741597594615828

  # Automatically turn Pihole back on after 20 mins and notify
  - alias: 'Turn Pihole back on'
    trigger:
        platform: state
        entity_id: switch.pihole
        to: 'off'
        for:
            minutes: 10
    action:
      - service: switch.turn_on
        entity_id: switch.pihole
